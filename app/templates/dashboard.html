{% extends 'base.html' %}
{% block head_extra %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "Dashboard",
  "url": "{{ canonical_url }}",
  "description": "{{ description or DEFAULT_DESCRIPTION }}"
}
</script>
{% endblock %}
{% block content %}
<section class="hero">
  <h1>Dashboard</h1>
  <p class="subtitle">Your personal Token Arena dashboard with portfolio analytics and insights.</p>
</section>

<section class="dashboard" id="dashboard">
  <div class="dashboard-grid">
    <div class="dashboard-card">
      <h3>Portfolio Overview</h3>
      <div class="portfolio-stats">
        <div class="stat">
          <div class="stat-label">Total Value</div>
          <div class="stat-value" id="portfolio-value">$0.00</div>
        </div>
        <div class="stat">
          <div class="stat-label">24h Change</div>
          <div class="stat-value" id="portfolio-change">0.00%</div>
        </div>
        <div class="stat">
          <div class="stat-label">Holdings</div>
          <div class="stat-value" id="portfolio-holdings">0</div>
        </div>
      </div>
    </div>

    <div class="dashboard-card">
      <h3>Top Holdings</h3>
      <div class="top-holdings" id="top-holdings">
        <div class="loading">Loading holdings...</div>
      </div>
    </div>

    <div class="dashboard-card">
      <h3>Recent Activity</h3>
      <div class="recent-activity" id="recent-activity">
        <div class="loading">Loading activity...</div>
      </div>
    </div>

    <div class="dashboard-card">
      <h3>Watchlist</h3>
      <div class="watchlist" id="watchlist">
        <div class="loading">Loading watchlist...</div>
      </div>
    </div>
  </div>
</section>

<script>
// Dashboard functionality
(async function() {
  const TB = window.TB || {};

  async function loadDashboard() {
    try {
      // Load user portfolio data
      const userResponse = await fetch('/api/auth/me');
      const userData = await userResponse.json();

      if (!userData.user) {
        document.getElementById('dashboard').innerHTML = `
          <div class="auth-required">
            <h3>Authentication Required</h3>
            <p>Please sign in to access your dashboard.</p>
            <button class="btn" onclick="window.location.href='/settings'">Sign In</button>
          </div>
        `;
        return;
      }

      // Load portfolio data
      const portfolioResponse = await fetch(`/api/users/${userData.user.npub}`);
      const portfolioData = await portfolioResponse.json();

      if (portfolioData.portfolio) {
        updatePortfolioOverview(portfolioData.portfolio);
        updateTopHoldings(portfolioData.holdings || []);
      }

      // Load recent activity (placeholder)
      updateRecentActivity([]);

      // Load watchlist (placeholder)
      updateWatchlist([]);

    } catch (error) {
      console.error('Error loading dashboard:', error);
      document.getElementById('dashboard').innerHTML = `
        <div class="error">
          <h3>Error Loading Dashboard</h3>
          <p>Unable to load your dashboard data. Please try again later.</p>
        </div>
      `;
    }
  }

  function updatePortfolioOverview(portfolio) {
    const totalValue = portfolio.total_value_usd || 0;
    const change24h = portfolio.change_24h || 0;
    const holdingsCount = portfolio.holdings_count || 0;

    document.getElementById('portfolio-value').textContent = `$${totalValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    document.getElementById('portfolio-change').textContent = `${change24h >= 0 ? '+' : ''}${change24h.toFixed(2)}%`;
    document.getElementById('portfolio-change').className = `stat-value ${change24h >= 0 ? 'positive' : 'negative'}`;
    document.getElementById('portfolio-holdings').textContent = holdingsCount;
  }

  function updateTopHoldings(holdings) {
    const container = document.getElementById('top-holdings');

    if (holdings.length === 0) {
      container.innerHTML = '<div class="no-data">No holdings found</div>';
      return;
    }

    container.innerHTML = holdings.slice(0, 5).map(holding => `
      <div class="holding-item">
        <div class="holding-symbol">${holding.symbol}</div>
        <div class="holding-amount">${holding.amount || 0}</div>
        <div class="holding-value">$${(holding.value_usd || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
      </div>
    `).join('');
  }

  function updateRecentActivity(activities) {
    const container = document.getElementById('recent-activity');

    if (activities.length === 0) {
      container.innerHTML = '<div class="no-data">No recent activity</div>';
      return;
    }

    container.innerHTML = activities.slice(0, 5).map(activity => `
      <div class="activity-item">
        <div class="activity-type">${activity.type}</div>
        <div class="activity-details">${activity.details}</div>
        <div class="activity-time">${activity.timestamp}</div>
      </div>
    `).join('');
  }

  function updateWatchlist(watchlist) {
    const container = document.getElementById('watchlist');

    if (watchlist.length === 0) {
      container.innerHTML = '<div class="no-data">No tokens in watchlist</div>';
      return;
    }

    container.innerHTML = watchlist.slice(0, 5).map(token => `
      <div class="watchlist-item">
        <div class="watchlist-symbol">${token.symbol}</div>
        <div class="watchlist-price">$${(token.price_usd || 0).toFixed(6)}</div>
        <div class="watchlist-change ${token.change_24h >= 0 ? 'positive' : 'negative'}">${token.change_24h >= 0 ? '+' : ''}${token.change_24h.toFixed(2)}%</div>
      </div>
    `).join('');
  }

  // Initialize dashboard
  loadDashboard();
})();
</script>

<style>
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.dashboard-card {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.dashboard-card h3 {
  margin-top: 0;
  margin-bottom: 15px;
  color: var(--text);
}

.portfolio-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 15px;
}

.stat {
  text-align: center;
}

.stat-label {
  font-size: 0.875rem;
  color: var(--text-secondary);
  margin-bottom: 5px;
}

.stat-value {
  font-size: 1.25rem;
  font-weight: bold;
  color: var(--text);
}

.stat-value.positive {
  color: #10b981;
}

.stat-value.negative {
  color: #ef4444;
}

.holding-item, .activity-item, .watchlist-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
}

.holding-item:last-child, .activity-item:last-child, .watchlist-item:last-child {
  border-bottom: none;
}

.holding-symbol, .activity-type, .watchlist-symbol {
  font-weight: 600;
  color: var(--text);
}

.holding-amount, .activity-details {
  color: var(--text-secondary);
  font-size: 0.875rem;
}

.holding-value, .activity-time, .watchlist-price {
  color: var(--text);
  font-size: 0.875rem;
}

.watchlist-change {
  font-size: 0.875rem;
  font-weight: 600;
}

.auth-required, .error {
  text-align: center;
  padding: 40px;
  background: var(--panel);
  border-radius: 12px;
  border: 1px solid var(--border);
}

.auth-required h3, .error h3 {
  margin-top: 0;
  color: var(--text);
}

.auth-required p, .error p {
  color: var(--text-secondary);
  margin-bottom: 20px;
}

.no-data {
  text-align: center;
  color: var(--text-secondary);
  padding: 20px;
}

.loading {
  text-align: center;
  color: var(--text-secondary);
  padding: 20px;
}
</style>
{% endblock %}